{% extends "base.html" %}
{% block title %}Dashboard Â· SHK CMS{% endblock %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<h1 class="h4 mb-3">Dashboard</h1>

<!-- ================= PRE-WEEK: Uncashed before Week 1 ================= -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-white fw-bold"></div>
  <div class="card-body">
    <div class="accordion" id="preWeekAccordion">
      <div class="accordion-item mb-2 border-0 shadow-sm rounded">
        <h2 class="accordion-header" id="headingPre">
          <button
            class="accordion-button flex-column align-items-start py-3 {% if not pre_week.days %}collapsed{% endif %}"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapsePre"
            aria-expanded="{{ 'true' if pre_week.days else 'false' }}"
            aria-controls="collapsePre"
          >
            <div class="w-100">
              <div class="fw-bold text-danger fs-6">Uncashed before Week 1</div>
              <div class="text-muted small">{{ pre_week.range_label }}</div>
              <div class="fw-semibold text-dark">â‚¹ {{ pre_week.total_amount | inr }}</div>
            </div>
          </button>
        </h2>
        <div
          id="collapsePre"
          class="accordion-collapse collapse {% if pre_week.days %}show{% endif %}"
          aria-labelledby="headingPre"
          data-bs-parent="#preWeekAccordion"
        >
          <div class="accordion-body">
            {% if pre_week.days %}
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th class="text-end">Amount</th>
                    <th class="text-end">Count</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in pre_week.days %}
                  <tr>
                    <td>{{ d.date }}</td>
                    <td class="text-end">
                      <a href="{{ url_for('cheques_by_date_html', date=d.date_iso) }}"
                         class="text-decoration-none"
                         data-bs-toggle="modal" data-bs-target="#chequeModal"
                         data-bs-remote="true">
                        â‚¹ {{ d.amount | inr }}
                      </a>
                    </td>
                    <td class="text-end">
                      <a href="{{ url_for('cheques_by_date_html', date=d.date_iso) }}"
                         class="text-decoration-none fw-semibold text-primary"
                         data-bs-toggle="modal" data-bs-target="#chequeModal"
                         data-bs-remote="true">
                        {{ d.count }}
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th>Total</th>
                    <th class="text-end">â‚¹ {{ pre_week.total_amount | inr }}</th>
                    <th class="text-end">{{ pre_week.total_count }}</th>
                  </tr>
                </tfoot>
              </table>
            </div>
            {% else %}
              <div class="text-muted">No uncashed cheques before this week ðŸŽ‰</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================= WEEKLY ACCORDION (Week 1 â†’ Week 4) ================= -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-white fw-bold">Cheques by Week </div>
  <div class="card-body">
    <div class="accordion" id="weeksAccordion">
      {% for w in weeks %}
      <div class="accordion-item mb-2 border-0 shadow-sm rounded">
        <h2 class="accordion-header" id="heading{{ loop.index }}">
          <button
            class="accordion-button {% if not loop.first %}collapsed{% endif %} flex-column align-items-start py-3"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapse{{ loop.index }}"
            aria-expanded="{{ 'true' if loop.first else 'false' }}"
            aria-controls="collapse{{ loop.index }}"
          >
            <div class="w-100">
              <div class="fw-bold text-primary fs-6">{{ w.title }}</div>
              <div class="text-muted small">{{ w.range_label }}</div>
              <div class="fw-semibold text-dark">â‚¹ {{ w.total_amount | inr }}</div>
            </div>
          </button>
        </h2>

        <div
          id="collapse{{ loop.index }}"
          class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
          aria-labelledby="heading{{ loop.index }}"
          data-bs-parent="#weeksAccordion"
        >
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th class="text-end">Amount</th>
                    <th class="text-end">Count</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in w.days %}
                  <tr>
                    <td>{{ d.date }}</td>
                    <td class="text-end">
                      <a href="{{ url_for('cheques_by_date_html', date=d.date_iso) }}"
                         class="text-decoration-none"
                         data-bs-toggle="modal" data-bs-target="#chequeModal"
                         data-bs-remote="true">
                        â‚¹ {{ d.amount | inr }}
                      </a>
                    </td>
                    <td class="text-end">
                      <a href="{{ url_for('cheques_by_date_html', date=d.date_iso) }}"
                         class="text-decoration-none fw-semibold text-primary"
                         data-bs-toggle="modal" data-bs-target="#chequeModal"
                         data-bs-remote="true">
                        {{ d.count }}
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot class="table-light">
                  <tr>
                    <th>Total</th>
                    <th class="text-end">â‚¹ {{ w.total_amount | inr }}</th>
                    <th class="text-end">{{ w.total_count }}</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ================= STATUS SUMMARY + PIE ================= -->
<div class="card shadow-sm">
  <div class="card-header bg-white fw-bold">Status Summary</div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <tbody>
          <tr><th>Issued Cheques</th><td class="text-end fw-semibold">{{ ci }}</td></tr>
          <tr><th>Active</th><td class="text-end fw-semibold">{{ ca }}</td></tr>
          <tr><th>Cashed</th><td class="text-end fw-semibold">{{ cc }}</td></tr>
          <tr><th>Cancelled</th><td class="text-end fw-semibold">{{ cn }}</td></tr>
          <tr><th>Bounced</th><td class="text-end fw-semibold">{{ cb }}</td></tr>
          <tr><th>Mistake</th><td class="text-end fw-semibold">{{ cm }}</td></tr>
        </tbody>
      </table>
    </div>
    <canvas id="statusPie" class="mt-3"></canvas>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<!-- Modal container (content loaded from /cheques/<date>) -->
<div class="modal fade" id="chequeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content"></div>
  </div>
</div>

<script>
  // --- one reusable instance ---
  const modalEl  = document.getElementById('chequeModal');
  const modalCt  = modalEl.querySelector('.modal-content');
  const bsModal  = bootstrap.Modal.getOrCreateInstance(modalEl, {
    backdrop: true,
    keyboard: true
  });

  // Open + load HTML into the modal
  document.addEventListener('click', function (e) {
    const link = e.target.closest('[data-bs-remote]');
    if (!link) return;

    e.preventDefault();
    modalCt.innerHTML = '<div class="p-4 text-center text-muted">Loading...</div>';

    fetch(link.href)
      .then(r => r.text())
      .then(html => { modalCt.innerHTML = html; })
      .catch(() => {
        modalCt.innerHTML = '<div class="p-4 text-center text-danger">Error loading details</div>';
      });

    bsModal.show();
  });

  // When the modal is fully hidden: clean up & refresh page
  modalEl.addEventListener('hidden.bs.modal', () => {
    // safety: remove any stray backdrops (in case of prior multiple instances)
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    modalCt.innerHTML = '';
    // refresh dashboard so the grey layer never lingers and data stays fresh
    window.location.reload();
  });
</script>

{% endblock %}
