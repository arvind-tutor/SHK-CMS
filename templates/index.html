{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-3">

  <h5 class="fw-semibold mb-3">Dashboard</h5>

  <!-- ðŸ§¾ Uncashed Before Week 1 -->
  <div class="accordion mb-3" id="accordionPreWeek">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingPreWeek">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapsePreWeek" aria-expanded="true"
                aria-controls="collapsePreWeek">
          <div>
            <div class="fw-bold text-danger">Uncashed before Week 1</div>
            <div class="small text-muted">Up to {{ pre_week.end_date }}</div>
            <div class="fw-semibold">â‚¹ {{ "{:,.0f}".format(pre_week.total) }}</div>
          </div>
        </button>
      </h2>
      <div id="collapsePreWeek" class="accordion-collapse collapse show"
           aria-labelledby="headingPreWeek" data-bs-parent="#accordionPreWeek">
        <div class="accordion-body p-2">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr><th>Date</th><th>Amount</th><th>Count</th></tr>
            </thead>
            <tbody>
              {% for d in pre_week.days %}
              <tr>
                <td>{{ d.date }}</td>
                <td>â‚¹ {{ "{:,.0f}".format(d.amount) }}</td>
                <td>
                  {% if d.count > 0 %}
                    <a href="{{ url_for('cheques_by_date_html', date=d.date_iso) }}"
                       class="text-decoration-none fw-semibold text-primary"
                       data-bs-toggle="modal" data-bs-target="#chequeModal"
                       data-bs-remote="true">{{ d.count }}</a>
                  {% else %}
                    {{ d.count }}
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              <tr class="fw-bold border-top">
                <td>Total</td>
                <td>â‚¹ {{ "{:,.0f}".format(pre_week.total) }}</td>
                <td>{{ pre_week.total_count }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ“† Cheques by Week -->
  <div class="accordion" id="accordionWeeks">
    <div class="card mb-2">
      <div class="card-header bg-light fw-semibold">Cheques by Week (Current â†’ 4th)</div>
    </div>
    {% for w in weeks %}
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="heading{{ loop.index }}">
        <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}"
                aria-expanded="{{ 'true' if loop.first else 'false' }}"
                aria-controls="collapse{{ loop.index }}">
          <div>
            <div class="fw-bold text-primary">Week {{ loop.index }}</div>
            <div class="small text-muted">{{ w.start }} â€“ {{ w.end }}</div>
            <div class="fw-semibold">â‚¹ {{ "{:,.0f}".format(w.total) }}</div>
          </div>
        </button>
      </h2>
      <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
           aria-labelledby="heading{{ loop.index }}" data-bs-parent="#accordionWeeks">
        <div class="accordion-body p-2">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr><th>Date</th><th>Amount</th><th>Count</th></tr>
            </thead>
            <tbody>
              {% for d in w.days %}
              <tr>
                <td>{{ d.date }}</td>
                <td>â‚¹ {{ "{:,.0f}".format(d.amount) }}</td>
                <td>
                  {% if d.count > 0 %}
                    <a href="{{ url_for('cheques_by_date_html', date=d.date_iso) }}"
                       class="text-decoration-none fw-semibold text-primary"
                       data-bs-toggle="modal" data-bs-target="#chequeModal"
                       data-bs-remote="true">{{ d.count }}</a>
                  {% else %}
                    {{ d.count }}
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              <tr class="fw-bold border-top">
                <td>Total</td>
                <td>â‚¹ {{ "{:,.0f}".format(w.total) }}</td>
                <td>{{ w.total_count }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ðŸ“Š Status Summary -->
  <div class="card mt-4">
    <div class="card-header bg-light fw-semibold">Status Summary</div>
    <div class="card-body p-2">
      <table class="table table-sm align-middle mb-0">
        <tr><td>Issued Cheques</td><td class="text-end">{{ ci }}</td></tr>
        <tr><td>Active</td><td class="text-end">{{ ca }}</td></tr>
        <tr><td>Cashed</td><td class="text-end">{{ cc }}</td></tr>
        <tr><td>Cancelled</td><td class="text-end">{{ cn }}</td></tr>
        <tr><td>Bounced</td><td class="text-end">{{ cb }}</td></tr>
        <tr><td>Mistake</td><td class="text-end">{{ cm }}</td></tr>
      </table>
    </div>
  </div>
</div>

<!-- ðŸªŸ Modal for daily cheques -->
<div class="modal fade" id="chequeModal" tabindex="-1" aria-labelledby="chequeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content"></div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script>
  // Bootstrap modal dynamic loader
  const modalEl = document.getElementById('chequeModal');

  modalEl.addEventListener('show.bs.modal', function (ev) {
    const trigger = ev.relatedTarget;
    const url = trigger && trigger.getAttribute('href');
    const content = modalEl.querySelector('.modal-content');
    content.innerHTML = '<div class="p-4 text-center text-muted">Loading...</div>';

    if (!url) {
      content.innerHTML = '<div class="p-4 text-danger">Invalid link</div>';
      return;
    }

    fetch(url)
      .then(r => r.text())
      .then(html => { content.innerHTML = html; })
      .catch(() => {
        content.innerHTML = '<div class="p-4 text-danger">Error loading details</div>';
      });
  });

  modalEl.addEventListener('hidden.bs.modal', function () {
    modalEl.querySelector('.modal-content').innerHTML = '';
  });
</script>
{% endblock %}
